# Export the best/most recent available JPEG preview image to the same folder as the 
# selected image files.

# Discussion related to this file:
# http://u88.n24.queensu.ca/exiftool/forum/index.php?topic=8765.msg45086#msg45086

# Order of preference for embedded images, in case more than one exists
# 1/ JpgFromRaw (assumed to be a processed version of the RAW, so most recent)
# 2/ PreviewImage (assumed to be the camera preview image)

# This config attempts to extract each image in turn. exiftool will not overrwrite an
# image file, so once an image is extracted subsequent extractions will do nothing.

# 1/ JpgFromRaw
-w
# Put all files in the same folder as the source image. Existing images will not be 
# overwritten but any new tags will be (re)written in to them later.
%d%f_%e.jpg

# Binary extraction (instead of just listing the binary tag attributes)  
-b
# Assume that JpgFromRaw is higher resolution or more recent than Preview Image
-preview:JpgFromRaw

# Run execute to copy the preview to a file now
-execute

# 2/ PreviewImage 
-if
not $JpgFromRaw
-w
%d%f_%e.jpg

-b
-preview:PreviewImage

# Extracted previews don't contain metadata, so now copy in tag values from the 
# source file.

# Run execute to extract the files ...
-execute

# ... and then copy metadata from the source file to the exported previews

# Check that the file exists to avoid error output if no preview could be extracted
-if
-e $filename

# If the jpg was not actually written by this action (maybe it was created 
# some time before) it might have it's own up to date metadata. So, don't 
# overwrite any existing tag values.
-writeMode
cg

-srcfile
%d%f_%e.jpg

# Get tags from the base raw file
-tagsFromFile
@
# ... then override with any newer values from the .xmp file if it exists
-tagsFromFile
%d%f.xmp

-overwrite_original
